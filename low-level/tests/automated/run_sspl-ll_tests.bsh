#!/bin/bash -e

echo "Running Automated Integration Tests for SSPL-LL"

# Speed up the dcs-collector during the tests so they don't take so long
grep -q -F "[drivemanager]\npoll_interval=5\n" /etc/dcs_collector.conf || \
	grep -q -F "[drivemanager]\n#poll_interval=5\n" /etc/dcs_collector.conf || \
	echo -e '[drivemanager]\npoll_interval=5\n' >> /etc/dcs_collector.conf
sed -i "s|^#poll_interval=5|poll_interval=5|g" /etc/dcs_collector.conf

# Make sure SSPL-LL is in a known default startup state
systemctl restart dcs-collector -l
systemctl restart sspl-ll -l

if [[ -f ./lettucetests.xml ]]; then
	rm ./lettucetests.xml
fi

# Execute tests and save results
lettuce --with-xunit --xunit-file=lettucetests.xml

# Reset dcs-collector to default polling time to avoid thrashing
sed -i "s|^poll_interval=5|#poll_interval=5|g" /etc/dcs_collector.conf
systemctl restart dcs-collector -l

# Search results for success
success=`grep 'testsuite errors="0" failures="0"' lettucetests.xml`
if [[ "$success" == "" ]]; then
	echo "Tests Failed, see lettucetests.xml for test results"
	echo 1
else
	echo "Tests ran successfully with no errors or failures"
	echo 0
fi
