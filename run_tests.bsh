#!/bin/bash -e

####################################################################################
# Performs automated integration tests on SSPL-LL by performing the following
#	1) Pulls the latest packages from the git repo and installs prerequisites
#	2) Uninstalls any previous SSPL-LL installations to avoid interference
#	3) Runs a series of tests by injecting actuator messages into RabbitMQ
#	4) Confirms the proper actuator JSON responses are generated by SSPL-LL
#	5) Manipulates the file system in /var/run/diskmonitor/drive_manager.json
#	6) Confirms the proper sensor JSON responses are generated by SSPL-LL
#	7) Uses Mock objects to inject events simulating external sensors
#
# To apply tests on code perform the following
#	Pull the code to be tested from master or branch
#	1) git clone <-b branch> ssh://[uid]@es-gerrit.xyus.xyratex.com:29418/sspl
#	Change to the sspl directory
#	2) cd sspl
#	Execute this test script
#	3) ./run_tests.bsh
#	It will exit 0 upon success and 1 if any tests failed or had errors
#
# WARNING: Do not run this script on a production system.  It will install
#          simulators that replace any live HPI data.
#
####################################################################################

TOP_DIR=`pwd`

# Install the lettuce test framework and dependencies
if [[ ! `yum list installed python-lettuce` ]]; then
    cd installation/deps
    chmod +x ./install_deps.bsh
    ./install_deps.bsh
fi


# Install the simulator for multiple drives
if [[ ! `yum list installed openhpi-dynamic_simulator` ]]; then
    tar xvf simulator.tgz
    cd simulator
    ./install_sim.bsh
fi

# Enable repo for rabbitmq-server and install
if [[ ! `yum list installed epel-release` ]]; then
    rpm -Uvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
fi
if [[ ! `yum list installed rabbitmq-server` ]]; then
    yum install -y rabbitmq-server python-psutil
fi

# Make sure rabbitmq is started before we initialize it
systemctl start rabbitmq-server -l

# Copy startup and config files
cd $TOP_DIR
cp installation/RPMs/low-level/files/sspl-ll /etc/init.d
cp installation/RPMs/low-level/files/sspl_ll.conf /etc

# Initialize rabbitmq queues and exchanges
chmod +x low-level/framework/sspl_ll_rabbitmq_reinit
low-level/framework/sspl_ll_rabbitmq_reinit

# Update service script to point to this installation
SSPL_d="low-level/framework/sspl_ll_d"
sed -i "s|^prog_name=|prog_name=$TOP_DIR/$SSPL_d\n#|g" /etc/init.d/sspl-ll

# Start openhpid
systemctl daemon-reload
systemctl restart openhpid -l

# Startup sspl-ll using this code
systemctl restart sspl-ll -l

# Execute tests
cd low-level/tests/automated
chmod +x run_sspl-ll_tests.bsh
./run_sspl-ll_tests.bsh

exit $?
