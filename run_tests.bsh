#!/bin/bash -e

####################################################################################
# Performs automated integration tests on SSPL-LL by performing the following
#	1) Pulls the latest packages from the git repo and installs prerequisites
#	2) Uninstalls any previous SSPL-LL installations to avoid interference
#	3) Runs a series of tests by injecting actuator messages into RabbitMQ
#	4) Confirms the proper actuator JSON responses are generated by SSPL-LL
#	5) Manipulates the file system in /var/run/diskmonitor/drive_manager.json
#	6) Confirms the proper sensor JSON responses are generated by SSPL-LL
#	7) Uses Mock objects to inject events simulating external sensors
#
# To apply tests on code perform the following
#	Pull the code to be tested from master or branch
#	1) git clone <-b branch> ssh://[uid]@es-gerrit.xyus.xyratex.com:29418/sspl
#	Change to the sspl directory
#	2) cd sspl
#	Execute this test script
#	3) ./run_tests.bsh
#	It will exit 0 upon success and 1 if any tests failed or had errors
#
# WARNING: Do not run this script on a production system.  It will install
#          simulators that replace any live HPI data which is most likely 
#	   not what you want.
#
####################################################################################


TOP_DIR=`pwd`

# Create simulated disk manager data
mkdir -p /var/run/diskmonitor
cp ./installation/deps/drive_manager.json /var/run/diskmonitor

# Copy over sudoers files
cp ./installation/deps/00aliases /etc/sudoers.d
cp ./installation/deps/sudoers /etc

# Copy over dcs-collector configuration file
cp ./installation/deps/dcs_collector.conf /etc

# Make sure rabbitmq is started before we initialize it
systemctl start rabbitmq-server -l

# Copy startup and config files
cp installation/deps/sspl-ll-test.service /etc/systemd/system/sspl-ll.service
cp installation/RPMs/low-level/files/sspl_ll.conf /etc

# Initialize rabbitmq queues and exchanges
chmod +x low-level/framework/sspl_ll_rabbitmq_reinit
low-level/framework/sspl_ll_rabbitmq_reinit

# Update service script to point to this installation
SSPL_d="low-level/framework/sspl_ll_d"

# Start openhpid
systemctl daemon-reload
systemctl restart openhpid -l

# Execute tests
cd low-level/tests/automated
chmod +x run_sspl-ll_tests.bsh
./run_sspl-ll_tests.bsh

exit $?
