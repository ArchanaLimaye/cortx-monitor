#!/bin/bash

# Stop the script if any command fails
set -e -u -o pipefail

script_dir=$(dirname $0)

# Import common constants
source $script_dir/constants.sh

SCRIPT_NAME=$(basename $0)

SSPL_CONFIGURED="/var/sspl/sspl-configured"

if [ -f $SSPL_CONF ]; then
    IFS='=' dp=`grep data_path $SSPL_CONF`; datapath=( $dp )
    SSPL_DATA_DIR=`echo ${datapath[1]}`
    IFS='=' lfp=`grep log_file_path $SSPL_CONF`; datapath=( $lfp )
    IEM_FILE_PATH=`echo ${datapath[1]}`
else
    SSPL_DATA_DIR="/var/sspl/data"
    IEM_FILE_PATH="/var/sspl/data/iem/iem_messages"
fi

usage() {
    cat << EOF
$SCRIPT_NAME [hard [-p <EES>]|soft]
hard options:
    -p product to be configured
EOF
    exit 1
}

hard_reset()
{
    PRODUCT=EES

    while [ $# -gt 0 ]; do
        case $1 in
            -p )
                [ $# -lt 2 ] && usage
                shift 1 && PRODUCT=$1
                [[ $PRODUCTS =~ (^| )$PRODUCT($| ) ]] || usage
                ;;
            * )
                usage
                ;;
        esac
        shift 1
    done


    # stop sspl service
    systemctl stop sspl-ll.service

    # Remove sspl_conf
    rm -f $SSPL_CONF
    
    # Remove sspl-configured file
    rm -f $SSPL_CONFIGURED

    # Remove sspl data
    rm -rf $SSPL_DATA_DIR

    # Remove sspl-ll user if preset
    id -u sspl-ll 2>/dev/null && export user_present=true || export user_present=false
    if [ "$user_present" = "true" ]; then
        /usr/sbin/userdel sspl-ll
    fi

    # Remove rabbitmq configurations
    systemctl status rabbitmq-server 1>/dev/null && export status=true || export status=false
    if [ "$status" = "false" ]; then
        systemctl start rabbitmq-server
    fi

    # Reset RabbitMQ configuration
    /sbin/rabbitmqctl stop_app;
    /sbin/rabbitmqctl reset;
    /sbin/rabbitmqctl start_app;

    # Remove log directories
    rm -rf /var/log/sspl
    rm -rf /var/log/iem

    # Remove rsyslog config files
    rm -f /etc/rsyslog.d/0-iemfwd.conf
    rm -f /etc/rsyslog.d/1-ssplfwd.conf

    # Remove logrotate config files
    rm -f /etc/logrotate.d/iem_messages
    rm -f /etc/logrotate.d/sspl_logs

}

soft_reset()
{
    # Remove .json files and truncate iem log file
    find $SSPL_DATA_DIR -type f -name "*.json" -exec rm -f {} \;
    truncate -s 0 $IEM_FILE_PATH
}

cmd=
[ $# -ge 1 ] && cmd=$1 && shift 1

case $cmd in
    hard )
        hard_reset $*
        ;;

    soft )
        soft_reset $*
        ;;

    * )
        usage
        ;;
esac
