#!/bin/bash

set -e -u -o pipefail

##############################################################################
# This script is meant to be used by developers. It calls all the provisioner
# scripts sequentially. It will replace sspl_init eventually.
##############################################################################

SCRIPT_DIR=$(dirname $0)

# Install consul if not available
if ! [ -x "$(command -v consul)" ]; then
    wget https://releases.hashicorp.com/consul/1.7.0/consul_1.7.0_linux_amd64.zip
    if ! [ -x "$(command -v unzip)" ]; then
        yum install -y unzip
    fi
    unzip consul_1.7.0_linux_amd64.zip
    mv ./consul /usr/bin
    rm consul_1.7.0_linux_amd64.zip
fi

# Start consul if not running
CONSUL_PS=$(ps -aux | grep "consul" | grep -v "grep" || true)
[ -z "$CONSUL_PS" ] && consul agent -dev &>/dev/null &

$SCRIPT_DIR/bin/sspl_post_install -p EES
$SCRIPT_DIR/bin/sspl_setup_init -r eos
$SCRIPT_DIR/bin/sspl_config
sudo systemctl start sspl-ll.service
sudo systemctl start rabbitmq-server.service

# TODO: Temporary change until HA integration is in place
# Switch SSPL to active state to resume all the suspended plugins. If SSPL is
# not switched to active state then plugins will not respond and tests will
# fail. Sending SIGUP to SSPL makes SSPL to read state file and switch state.
echo "*************************************************************************"
echo "Changing SSPL state to 'active', disable step once HA integration complete"
echo "*************************************************************************"
echo "state=active" > /var/sspl/data/state.txt
PID=`ps -aux| grep "sspl_ll_d -c /etc/sspl.conf" | grep -v "grep" | awk '{print $2}'`
kill -s SIGHUP $PID

